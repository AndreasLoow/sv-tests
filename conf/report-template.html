{% if False %}
<!-- vim: set ts=2 sts=2 sw=2 et: -->
{% endif %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>SystemVerilog Report</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>

    <!-- custom sorting for the chapter IDs -->
    <script>
      function isChapterNumber(a) {
        var parts = a.split(".");

        for (var i = 0; i < parts.length; i++) {

        if (isNaN(Number(parts[i]))) {
           return false;
         }
       }

        return true;
      };

      function chapterNumberCompare(a, b) {
        if (!isChapterNumber(a)) {
          if (!isChapterNumber(b)) {
            return ((a < b) ? -1 : ((a > b) ? 1 : 0));
          } else {
            return -1;
          }
        } else if (!isChapterNumber(b)) {
          return 1;
        }

        var a_parts = a.split(".");
        var b_parts = b.split(".");

        /* One or none of these loops will be executed */
        while (a_parts.length < b_parts.length) {
          a_parts.push("0");
        }

        while (a_parts.length > b_parts.length) {
          b_parts.push("0");
        }

        for (var i = 0; i < a_parts.length; i++) {
          if (Number(a_parts[i]) == Number(b_parts[i])) {
            continue;
          } else if (Number(a_parts[i]) < Number(b_parts[i])) {
            return -1;
          } else if (Number(a_parts[i]) > Number(b_parts[i])) {
            return 1;
          }
        }

        return 0;
      }

      $.fn.dataTable.ext.type.order['sv-id-asc'] = function (a, b) {
        return chapterNumberCompare(a, b);
      };

      $.fn.dataTable.ext.type.order['sv-id-desc'] = function (a, b) {
        return chapterNumberCompare(b, a);
      };
    </script>

    <script>
      $.fn.dataTable.ext.order['test-status'] = function ( settings, col ) {
        return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {

          if (td.className.includes("test-passed")) {
            return 1;
          }

          if (td.className.includes("test-failed")) {
            return 2;
          }

          if (td.className.includes("test-varied")) {
            return 3;
          }

          return 4;
        });
      };
    </script>

    <script>
      $(document).ready( function () {
        $('#report_table').DataTable( {
          paging: false,
          "columnDefs": [ { "type": "sv-id", targets: 0 } ],
          "columns": [
            null,
            {% for tool in report %}
            { "orderDataType": "test-status" },
            {% endfor %}
          ]
        });
      } );
    </script>

    <!-- override some defautl styles -->
    <style type="text/css">
      table.dataTable {
        width: auto;
        table-layout: fixed;
      }
      table.dataTable tbody tr th {
        width: calc(100% / {{ report.keys()|length + 1}} );
      }

      .ui-widget-shadow {
        -webkit-box-shadow: none;
        box-shadow: none;
      }

      .ui-tooltip {
        font-family: "Courier New", Courier, monospace;
        font-size: 13px;
        font-weight: normal;
      }

      .ui-corner-all {
        border-radius: 0px;
      }

      .test-cell {
        border: 1px;
        border-color: #505050;
        border-style: dotted;
        cursor: pointer;

        font-family: "Courier New", Courier, monospace;
        font-size: 10px;
        font-weight: normal;
      }

      .test-cell-selected {
        border: 2px solid black;
        font-weight: bold;
      }

      .test-failed {
        background-color: #ff6961;
      }
      .test-passed {
        background-color: #89E894;
      }
      .test-varied {
        background-color: #ffd761;
      }
      .test-na {
        background-color: #cfcece;
      }

      .logfile {
        display: none;
        position: fixed;
        bottom: 0;
        right: 10%;
        left: 10%;
        width: 80%;
        max-height: 60%;
        border: 2px solid black;
        overflow-y: hidden;
        overflow-x: hidden;
        z-index: 10;
        font-family: "Courier New", Courier, monospace;
      }
      .logfile-inner {
        overflow-y: scroll;
        overflow-x: hidden;
        max-height: calc(60vh - 50px);
        display: none;
        cursor: text;
      }
      .logtab-bar {
        background-color: #666;
        height: 50px;
        min-height: 50px;
      }
      .logtab-btn {
        padding: 4px;
        margin: 0px;
        cursor: pointer;
        font-size: 17px;
        height: 100%;
        border: 2px solid #666;
      }
      .logtab-close-btn {
        background: #cfcece;
        float: right;
      }
      .logtab-tab-btn {
        float: left;
      }
      .logtab-btn-selected {
        border-top: 0px;
      }
      .logfile-tab {
        z-index: 11;
        float: left;
        cursor: pointer;
      }
      .logfile-shown {
        display: block;
      }
      .logtab-shown {
        display: block;
      }

      button:focus {outline:0;}

    </style>

    <script>
      function toggleLog(div_id, cell_id) {
        all_logs = document.getElementsByClassName("logfile-shown");

        for (var i=0; i < all_logs.length; ++i) {
          if (all_logs[i].id != div_id) {
            hideLog(all_logs[i].id);
          }
        }

        log_div = document.getElementById(div_id);
        log_div.classList.toggle("logfile-shown");

        cell = document.getElementById(cell_id);
        cell.classList.toggle("test-cell-selected");
      }

      function hideLog(div_id) {
        log_div = document.getElementById(div_id);
        log_div.classList.remove("logfile-shown");

        cells = document.getElementsByClassName("test-cell-selected");
        for (var i=0; i < cells.length; ++i) {
          cells[i].classList.remove("test-cell-selected");
        }
      }

      function selectTab(group, test, btn_id) {
        all_tabs = document.getElementsByClassName(group);
        tab_id = group + "-" + test;

        all_btns = document.getElementsByClassName("logtab-btn-selected");

        for (var i=0; i < all_btns.length; ++i) {
          if (all_btns[i].parentElement.id == group + "-bar") {
            if (all_btns[i].id != btn_id) {
              all_btns[i].classList.remove("logtab-btn-selected");
            }
          }
        }

        for (var i=0; i < all_tabs.length; ++i) {
          if (all_tabs[i].id != tab_id) {
            all_tabs[i].classList.remove("logtab-shown");
          }
        }

        chosen_tab = document.getElementById(tab_id);
        chosen_tab.classList.toggle("logtab-shown");

        btn = document.getElementById(btn_id);

        btn.classList.toggle("logtab-btn-selected");
      }
    </script>

    <script>
      $(function() {
        $(document).tooltip({
          track: true,
          show: 0,
          hide: 0
        });
      });
    </script>
  </head>

  {% for tag, info in database.items() %}
  {% for tool, tooldata in report.items() %}
  {% if "test-na" not in tooldata["tags"][tag]["status"] %}
  <div class="logfile"
       id="{{ tool }}-{{ tag }}-logfile">
    {% for test, output in tooldata["tags"][tag]["logs"].items() %}
    <div id="logtab-{{tool}}-{{tag}}-{{test}}"
         class="logtab-{{tool}}-{{tag}} logfile-inner
                {% if loop.first %} logtab-shown {% endif %}
                {{output["status"]}}">
    {{output["log"]}}
    </div>
    {% endfor %}
    <div class="logtab-bar"
         id="logtab-{{tool}}-{{tag}}-bar">
      {% for test, output in tooldata["tags"][tag]["logs"].items() %}
      <button class="logtab-btn
                     logtab-tab-btn
                     {{output["status"]}}
                     {% if loop.first %} logtab-btn-selected {% endif %}
                     "
              id="logtab-btn-{{tool}}-{{tag}}-{{test}}"
              onclick='selectTab("logtab-{{tool}}-{{tag}}",
                                 "{{test}}",
                                 "logtab-btn-{{tool}}-{{tag}}-{{test}}")'
        >
        {{ test }}</button>
      {% endfor %}

      <button class="logtab-btn logtab-close-btn"
              onclick='hideLog("{{ tool }}-{{ tag }}-logfile")'>
        close
      </button>
    </div>
  </div>
  {% endif %}
  {% endfor %}
  {% endfor %}

  <body>
    <table id="report_table">
      <thead>
        <tr>
          <th>  </th>
          {% for tool in report %}
          <th> {{ tool }} </th>
          {% endfor %}
        </tr>
      </thead>
        {% for tag, info in database.items() %}
        <tr>
          <th title="{{info}}"> {{ tag }} </th>
          {% for tool, tooldata in report.items() %}
          <th class="{{ tooldata["tags"][tag]["status"] }}
            {% if "test-na" not in tooldata["tags"][tag]["status"] %} test-cell {% endif %}"
            {% if "test-na" not in tooldata["tags"][tag]["status"] %}
            id='{{tool}}-{{tag}}-cell'
            onclick='toggleLog("{{ tool }}-{{ tag }}-logfile", "{{tool}}-{{tag}}-cell")'
            {% endif %}
            >
            {% if "test-na" not in tooldata["tags"][tag]["status"] %}
            {{ tooldata["tags"][tag]["passed-num"] }}/{{ tooldata["tags"][tag]["logs"]|length }}
            {% endif %}
          </th>
          {% endfor %}
        </tr>
      {% endfor %}
    </table>
  </body>

</html>
