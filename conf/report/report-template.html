{# vim: set ts=2 sts=2 sw=2 et: #}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>SystemVerilog Report</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>

    {# Global parameters for scripts and stylesheets #}
    <script>
      var TOOL_NAMES = [{{'"' ~ report.keys()|sort|join('", "') ~ '"'}}];
      var TOOLS_COUNT = {{report|length}};
    </script>
    <style>:root { --TOOLS_COUNT: {{report|length}}; }</style>

    <link rel="stylesheet" type="text/css" href="report.css">
    <script type="text/javascript" charset="utf8" src="report.js"></script>
    <script type="text/javascript" charset="utf8" src="filter.js"></script>
  </head>
  <body>
    <header>
      <h1><a href="https://github.com/chipsalliance/sv-tests">SV-Tests</a></h1>
      <p><a href="https://github.com/chipsalliance/sv-tests"><em>Test suite to check compliance with the SystemVerilog LRM by chapter as well as some real-world cores and test-cases.</em></a></p>
    </header>
    <main>
      <section id="filter-section">
        <button onclick="toggleFilters()">Show advanced filters (experimental)</button>
        <section style="display: none;" id="filter">
          <ul class="filter-entries">
          </ul>
          <div>
            <button class="filter-add" onclick="addOptions()">Add</button>
            <button class="filter-apply" onclick="applyFilter()">Apply</button>
            <button class="filter-remove" onclick="removeAll()">Remove all filters</button>
          </div>
        </section>
      </section>
      <table id="report_table" class="dataTable">
        <thead>
          <tr>
            <th></th>
            <th></th>
            {% for tool, tooldata in report|dictsort %}
            <th title="{{report[tool]['version']|e|replace('\n', '&#10;')}}" style="--z: {{loop.length - loop.index}}">
              <a class="tool_link" target="_blank" href="{{report[tool]["url"]}}">{{tool|e}}</a>
            </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for tag, info in database|dictsort %}
          {%   set types_used_in_the_row = [] %}
          {%   for tool, tooldata in report|dictsort %}
          {%     for type in tooldata["tags"][tag]["type"] %}
          {%       if type not in types_used_in_the_row %}
          {%         set _ = types_used_in_the_row.append(type) %}
          {%       endif %}
          {%     endfor %}
          {%   endfor %}
          <tr class="{{types_used_in_the_row|join(' ')}}" data-tag="{{tag|e}}">
            <th title="{{info|e|replace('\n', '&#10;')}}">
              {%- if tag in database_urls -%}
              <a class="tag_link" target="_blank" href="{{database_urls[tag]}}">{{info|e}}</a>
              {%- else -%}
              {{info|e}}
              {%- endif -%}
            </th>
            <th title="{{info|e|replace('\n', '&#10;')}}">{{tag|e}}</th>
            {% for tool, tooldata in report|dictsort %}
            {%   set test_data = tooldata['tags'][tag] %}
            {%   set test_status = test_data['status'] %}
            {%   set attrs = [] %}
            {%   if test_status != 'test-na' %}
            {%     set head_test = test_data['logs'][test_data['head_test']]['name'] %}
            {%     set _ = attrs.append('class="'~test_status~'"') %}
            {%     set _ = attrs.append('data-tool="'~(tool|e)~'"') %}
            {%     set _ = attrs.append('data-head-test="'~(head_test|e)~'"') %}
            {%     if test_status == 'test-varied' %}
            {%       set percentage = '%0.0f'|format(100.0 * test_data['passed-num'] / test_data['logs']|length) %}
            {%       set _ = attrs.append('style="--val: '~(percentage)~'%"') %}
            {%     endif %}
            <td {{attrs|join(' ')}}>{{test_data['passed-num']}}/{{test_data['logs']|length}}</td>
            {%   else %}
            <td></td>
            {%   endif %}
            {% endfor %}
          </tr>
        {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="2">Total tests passed</th>
            {% for tool, tooldata in report|dictsort %}
            {%   set passed_tests = tooldata['total']['tests'] %}
            {%   set total_tests = tooldata['tests']|length %}
            {%   set passed_tests_percentage = '%0.0f'|format(100.0 * passed_tests / total_tests) %}
            <td class="test-varied" style="--val: {{passed_tests_percentage}}%" title="{{tool|lower|e}} ({{passed_tests_percentage}}%)">{{passed_tests}}/{{total_tests}}</td>
            {% endfor %}
          </tr>
          <tr>
            <th colspan="2">Total tags passed</th>
            {% for tool, tooldata in report|dictsort %}
            {%   set passed_tags = tooldata['total']['tags'] %}
            {%   set tested_tags = tooldata['total']['tested_tags'] %}
            {%   set passed_tags_percentage = '%0.0f'|format(100.0 * passed_tags / tested_tags) %}
            <td class="test-varied" style="--val: {{passed_tags_percentage}}%" title="{{tool|lower|e}} ({{passed_tags_percentage}}%)">{{passed_tags}}/{{tested_tags}}</td>
            {% endfor %}
          </tr>
          <tr>
            <th colspan="2">Total time elapsed</th>
            {% for tool, tooldata in report|dictsort %}
            <td title="{{tool|lower|e}}">{{'%0.0f'|format(tooldata["time_elapsed"])}}s</td>
            {% endfor %}
          </tr>
          <tr>
            <th colspan="2">User time elapsed</th>
            {% for tool, tooldata in report|dictsort %}
            <td title="{{tool|lower|e}}">{{'%0.0f'|format(tooldata["user_time"])}}s</td>
            {% endfor %}
          </tr>
          <tr>
            <th colspan="2">System time elapsed</th>
            {% for tool, tooldata in report|dictsort %}
            <td title="{{tool|lower|e}}">{{'%0.0f'|format(tooldata["system_time"])}}s</td>
            {% endfor %}
          </tr>
          <tr>
            <th colspan="2">Maximum ram usage</th>
            {% for tool, tooldata in report|dictsort %}
            <td title="{{tool|lower|e}}">{{'%0.0f'|format(tooldata["ram_usage"])}} MB</td>
            {% endfor %}
          </tr>
          <tr>
            <th colspan="2">Average throughput passed for inputs &gt; 1KiB</th>
            {% for tool, tooldata in report|dictsort %}
            <td title="{{tool|lower|e}}">{{'%0.0f'|format(tooldata["passed_throughput"]|float)}} KiB/s</td>
            {% endfor %}
          </tr>
        </tfoot>
      </table>
      <section id="summary-section">
        <a href="report.csv">Download a summary in csv</a>
      </section>
    </main>
    <footer id="footer">
      <p>
        Generated using <a href="https://github.com/chipsalliance/sv-tests">sv-tests</a>,
        revision: <a href="https://github.com/chipsalliance/sv-tests/commit/{{revision}}">{{revision}}</a>,
        {% if build_id != 'local' %}
        build_id: <a href="{{'https://github.com/chipsalliance/sv-tests/actions/runs/' ~ build_id|string}}">{{build_id}}</a>,
        {% else %}
        build_id: {{build_id}},
        {% endif %}
        date: {{datetime}}.
      </p>
    </footer>

    <div id="logfile-outer">
      <div class="iframe-wrap">
        <iframe class="iframe-log" name="log-frame"></iframe>
      </div>
      <div class="iframe-wrap">
        <iframe class="iframe-log" name="file-frame"></iframe>
      </div>
      {% for tag, info in database.items() %}
      {%   for tool, tooldata in report.items() %}
      {%     if "test-na" not in tooldata["tags"][tag]["status"] %}
      <div id="{{tool}}-{{tag}}-logfile" class="logfile">
        <div id="logtab-{{tool}}-{{tag}}-bar" class="logtab-bar">
          <button class="logtab-btn logtab-close-btn" onclick="toggleLog('{{tool}}', '{{tag}}', null)">close</button>
          {% for test, output in tooldata["tags"][tag]["logs_sorted"] %}
          <button id="logtab-btn-{{tool}}-{{tag}}-{{output['name']}}" class="logtab-btn logtab-tab-btn {{output["status"]}} sorted" {#
               #} onclick="selectTab('{{output['fname']}}', {#
                                   #}'logtab-btn-{{tool}}-{{tag}}-{{output['name']}}', {#
                                   #}'{{output['first_file']}}', {#
                                   #}'{{output['name']}}')">{{output["name"]}}</button>
          {% endfor %}
        </div>
      </div>
      {%     endif %}
      {%   endfor %}
      {% endfor %}
    </div>
  </body>
</html>
